<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒì¼ ê´€ë¦¬</title>
      <!-- CSS íŒŒì¼ë“¤ ì„í¬íŠ¸ -->
      <link rel="stylesheet" href="../../css/common.css">
      <link rel="stylesheet" href="../../css/file.css">
</head>
<body>
    <div class="files-container">
        <!-- íŒŒì¼ ì…ë ¥ (ìˆ¨ê¹€) -->
        <input type="file" id="file-input" multiple accept="*/*">

        <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
        <div id="alert-container"></div>

        <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="upload-section">
            <div class="upload-area" id="upload-area" onclick="triggerFileUpload()">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-title">íŒŒì¼ ì—…ë¡œë“œ</div>
                <div class="upload-description">
                    íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”<br>
                    ìµœëŒ€ 50MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤
                </div>
                <button class="upload-button" type="button">ğŸ“¤ íŒŒì¼ ì„ íƒ</button>
            </div>

            <!-- ê¶Œí•œ ì„¤ì • ì˜µì…˜ -->
            <div class="upload-options" id="upload-options" style="display: none;">
                <div class="options-title">ğŸ“‹ íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ ì„¤ì •</div>
                
                <div class="form-group">
                    <label class="form-label" for="min-role">ìµœì†Œ ì ‘ê·¼ ì§ê¸‰ (ì„ íƒ)</label>
                    <select class="form-select" id="min-role">
                        <option value="">ëª¨ë“  ì§ê¸‰</option>
                        <option value="ì‚¬ì›">ì‚¬ì› ì´ìƒ</option>
                        <option value="ëŒ€ë¦¬">ëŒ€ë¦¬ ì´ìƒ</option>
                        <option value="ê³¼ì¥">ê³¼ì¥ ì´ìƒ</option>
                        <option value="íŒ€ì¥">íŒ€ì¥ ì´ìƒ</option>
                        <option value="ë¶€ì¥">ë¶€ì¥ ì´ìƒ</option>
                        <option value="ì´ì‚¬">ì´ì‚¬ ì´ìƒ</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="valid-from">ì ‘ê·¼ ì‹œì‘ì¼ (ì„ íƒ)</label>
                        <input type="date" class="form-input" id="valid-from">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="valid-to">ì ‘ê·¼ ì¢…ë£Œì¼ (ì„ íƒ)</label>
                        <input type="date" class="form-input" id="valid-to">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="description">íŒŒì¼ ì„¤ëª… (ì„ íƒ)</label>
                    <input type="text" class="form-input" id="description" placeholder="íŒŒì¼ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
            <div class="upload-progress" id="upload-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">ì—…ë¡œë“œ ì¤‘...</div>
            </div>
        </div>

        <!-- íŒŒì¼ ëª©ë¡ ì„¹ì…˜ -->
        <div class="files-section">
            <div class="files-header">
                <div>
                    <div class="files-title">ğŸ“ ì±„ë„ íŒŒì¼</div>
                    <div class="files-count" id="files-count">íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
                <button class="upload-button" onclick="triggerFileUpload()">+ íŒŒì¼ ì¶”ê°€</button>
            </div>

            <!-- ë¡œë”© ìƒíƒœ -->
            <div class="loading" id="loading-state">
                <div class="loading-spinner"></div>
                íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>

            <!-- íŒŒì¼ ëª©ë¡ -->
            <div class="files-list" id="files-list">
                <!-- íŒŒì¼ ì•„ì´í…œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        // ============================
        // ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •
        // ============================
        
        const API_BASE_URL = 'http://localhost:8000';
        
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì±„ë„ ì •ë³´ ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const channelName = urlParams.get('channel') || 'default';
        const workspaceName = urlParams.get('workspace') || 'default';
        const workspaceId = urlParams.get('workspace_id') || localStorage.getItem('current_workspace_id');
        const channelId = urlParams.get('channel_id');
        const IS_DEV_MODE = urlParams.get('dev') === 'true' || 
                            window.location.hostname === 'localhost' ||
                            window.location.protocol === 'file:';

        // Mock ë°ì´í„° (ê°œë°œ ëª¨ë“œìš©)
        const MOCK_FILES = {
            'ì „ì²´': [
                {
                    file_id: 1,
                    filename: '2025ë…„ ì‚¬ì—…ê³„íšì„œ.pdf',
                    file_size: 2048576,
                    mime_type: 'application/pdf',
                    description: '2025ë…„ë„ ì „ì²´ ì‚¬ì—… ê³„íš',
                    min_role_name: 'ê³¼ì¥',
                    valid_from: '2025-01-01',
                    valid_to: '2025-12-31',
                    uploaded_by: 'í™ê¸¸ë™',
                    uploaded_at: '2025-01-15T09:30:00',
                    download_url: '#'
                },
                {
                    file_id: 2,
                    filename: 'íŒ€ë¹Œë”© ì‚¬ì§„ëª¨ìŒ.zip',
                    file_size: 15728640,
                    mime_type: 'application/zip',
                    description: '2024ë…„ í•˜ë°˜ê¸° íŒ€ë¹Œë”© ì‚¬ì§„',
                    min_role_name: null,
                    valid_from: null,
                    valid_to: null,
                    uploaded_by: 'ê¹€ëŒ€ë¦¬',
                    uploaded_at: '2025-01-10T14:20:00',
                    download_url: '#'
                }
            ],
            'ê°œë°œíŒ€': [
                {
                    file_id: 3,
                    filename: 'API_Document_v2.pdf',
                    file_size: 1024000,
                    mime_type: 'application/pdf',
                    description: 'API ëª…ì„¸ì„œ ë²„ì „ 2.0',
                    min_role_name: 'ëŒ€ë¦¬',
                    valid_from: '2025-01-01',
                    valid_to: null,
                    uploaded_by: 'ê°œë°œìA',
                    uploaded_at: '2025-01-20T11:00:00',
                    download_url: '#'
                }
            ],
            'ë””ìì¸': []
        };

        let currentFiles = [];
        let selectedFiles = [];

        // ============================
        // ê³µí†µ API í˜¸ì¶œ í•¨ìˆ˜
        // ============================
        
        // ê°œë°œ ëª¨ë“œìš© API ì‹œë®¬ë ˆì´ì…˜
        async function devApiCall(url, options = {}) {
            console.log(`ğŸ”§ DEV MODE: API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜ - ${options.method || 'GET'} ${url}`);
            
            await new Promise(resolve => setTimeout(resolve, 300));
            
            if (url.includes('/files') && options.method === 'POST') {
                // íŒŒì¼ ì—…ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
                const newFile = {
                    file_id: Date.now(),
                    filename: `ì—…ë¡œë“œëœ_íŒŒì¼_${Date.now()}.pdf`,
                    file_size: 1024000,
                    mime_type: 'application/pdf',
                    description: 'ìƒˆë¡œ ì—…ë¡œë“œëœ íŒŒì¼',
                    min_role_name: null,
                    valid_from: null,
                    valid_to: null,
                    uploaded_by: 'í˜„ì¬ì‚¬ìš©ì',
                    uploaded_at: new Date().toISOString(),
                    download_url: '#'
                };
                
                // Mock ë°ì´í„°ì— ì¶”ê°€
                if (!MOCK_FILES[channelName]) {
                    MOCK_FILES[channelName] = [];
                }
                MOCK_FILES[channelName].push(newFile);
                
                return newFile;
            }
            
            if (url.includes('/files') && options.method === 'DELETE') {
                // íŒŒì¼ ì‚­ì œ ì‹œë®¬ë ˆì´ì…˜
                const fileId = parseInt(url.split('/files/')[1]);
                if (MOCK_FILES[channelName]) {
                    const index = MOCK_FILES[channelName].findIndex(f => f.file_id === fileId);
                    if (index !== -1) {
                        MOCK_FILES[channelName].splice(index, 1);
                    }
                }
                return { message: 'íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' };
            }
            
            if (url.includes('/files')) {
                // íŒŒì¼ ëª©ë¡ ì¡°íšŒ ì‹œë®¬ë ˆì´ì…˜
                return { files: MOCK_FILES[channelName] || [] };
            }
            
            return {};
        }
        
        async function apiCall(endpoint, options = {}) {
            if (IS_DEV_MODE) {
                return await devApiCall(endpoint, options);
            }
            
            try {
                const token = localStorage.getItem('access_token');
                const defaultHeaders = {
                    'Authorization': `Bearer ${token}`
                };

                // FormDataì¸ ê²½ìš° Content-Typeì„ ìë™ ì„¤ì •í•˜ë„ë¡ í•¨
                if (!(options.body instanceof FormData)) {
                    defaultHeaders['Content-Type'] = 'application/json';
                }

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API í˜¸ì¶œ ì˜¤ë¥˜ (${endpoint}):`, error);
                throw error;
            }
        }

        // ============================
        // íŒŒì¼ ëª©ë¡ ë¡œë“œ
        // ============================
        async function loadFiles() {
            try {
                showLoading(true);
                
                // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì™€ ì±„ë„ ì •ë³´ë¥¼ í¬í•¨í•œ íŒŒì¼ ëª©ë¡ ìš”ì²­
                let endpoint;
                if (channelId) {
                    endpoint = `/channels/${channelId}/files`;
                } else {
                    endpoint = `/workspaces/${workspaceId}/channels/${channelName}/files`;
                }

                const data = await apiCall(endpoint);
                currentFiles = data.files || data || [];
                
                renderFiles();
                updateFilesCount();
                
            } catch (error) {
                console.error('íŒŒì¼ ë¡œë”© ì‹¤íŒ¨:', error);
                showAlert('íŒŒì¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                
                // ì—ëŸ¬ ì‹œ ë¹ˆ ëª©ë¡ìœ¼ë¡œ í‘œì‹œ
                currentFiles = [];
                renderFiles();
                updateFilesCount();
            } finally {
                showLoading(false);
            }
        }

        // ============================
        // UI ë Œë”ë§
        // ============================

        // íŒŒì¼ ëª©ë¡ ë Œë”ë§
        function renderFiles() {
            const filesList = document.getElementById('files-list');
            
            if (currentFiles.length === 0) {
                filesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-title">ì•„ì§ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-state-description">
                            ì²« ë²ˆì§¸ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ íŒ€ì›ë“¤ê³¼ ê³µìœ í•´ë³´ì„¸ìš”!<br>
                            ë“œë˜ê·¸ì•¤ë“œë¡­ ë˜ëŠ” ìœ„ì˜ ì—…ë¡œë“œ ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                        </div>
                    </div>
                `;
                return;
            }

            filesList.innerHTML = currentFiles.map(file => {
                const fileIcon = getFileIcon(file.filename);
                const fileSize = formatFileSize(file.file_size);
                const uploadTime = formatDate(file.uploaded_at || file.created_at);
                const canDelete = canUserDeleteFile(file);

                return `
                    <div class="file-item" data-file-id="${file.file_id || file.id}">
                        <div class="file-icon">${fileIcon}</div>
                        <div class="file-info">
                            <div class="file-name">${file.filename}</div>
                            <div class="file-meta">
                                ${fileSize} â€¢ ${file.uploaded_by || file.uploader_name || 'ì•Œ ìˆ˜ ì—†ìŒ'} â€¢ ${uploadTime}
                                ${file.description ? `<br>${file.description}` : ''}
                            </div>
                            <div class="file-tags">
                                ${file.min_role_name ? `<span class="file-tag role">ğŸ”’ ${file.min_role_name} ì´ìƒ</span>` : ''}
                                ${file.valid_from && file.valid_to ? `<span class="file-tag period">ğŸ“… ${file.valid_from} ~ ${file.valid_to}</span>` : ''}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn download" onclick="downloadFile(${file.file_id || file.id}, '${file.filename}')" title="ë‹¤ìš´ë¡œë“œ">
                                ğŸ“¥
                            </button>
                            <button class="file-action-btn" onclick="shareFile('${file.filename}')" title="ê³µìœ ">
                                ğŸ”—
                            </button>
                            ${canDelete ? `
                                <button class="file-action-btn delete" onclick="deleteFile(${file.file_id || file.id})" title="ì‚­ì œ">
                                    ğŸ—‘ï¸
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // íŒŒì¼ ì•„ì´ì½˜ ë°˜í™˜
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'ğŸ“„', 'doc': 'ğŸ“„', 'docx': 'ğŸ“„', 'txt': 'ğŸ“„',
                'xls': 'ğŸ“Š', 'xlsx': 'ğŸ“Š', 'csv': 'ğŸ“Š',
                'ppt': 'ğŸ“Š', 'pptx': 'ğŸ“Š',
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸', 'svg': 'ğŸ–¼ï¸',
                'fig': 'ğŸ¨', 'sketch': 'ğŸ¨', 'ai': 'ğŸ¨', 'psd': 'ğŸ¨',
                'js': 'ğŸ’»', 'html': 'ğŸ’»', 'css': 'ğŸ’»', 'py': 'ğŸ’»', 'java': 'ğŸ’»',
                'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦',
                'mp4': 'ğŸ¥', 'avi': 'ğŸ¥', 'mov': 'ğŸ¥',
                'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ'
            };
            return iconMap[extension] || 'ğŸ“„';
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            if (!dateString) return 'ì•Œ ìˆ˜ ì—†ìŒ';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // íŒŒì¼ ì‚­ì œ ê¶Œí•œ í™•ì¸
        function canUserDeleteFile(file) {
            // ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ê¶Œí•œì„ ì²´í¬í•˜ì§€ë§Œ, 
            // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ê¸°ë³¸ì ì¸ ì²´í¬
            return true; // ì„œë²„ì—ì„œ ìµœì¢… ê¶Œí•œ ì²´í¬
        }

        // íŒŒì¼ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateFilesCount() {
            const count = currentFiles.length;
            const countElement = document.getElementById('files-count');
            countElement.textContent = `ì´ ${count}ê°œì˜ íŒŒì¼`;
        }

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        function showLoading(show) {
            const loadingElement = document.getElementById('loading-state');
            const filesListElement = document.getElementById('files-list');
            
            if (show) {
                loadingElement.style.display = 'flex';
                filesListElement.style.display = 'none';
            } else {
                loadingElement.style.display = 'none';
                filesListElement.style.display = 'block';
            }
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert ${type}">
                    ${message}
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // 3ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 3000);
        }

        // ============================
        // íŒŒì¼ ì—…ë¡œë“œ
        // ============================

        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const uploadOptions = document.getElementById('upload-options');
        const uploadProgress = document.getElementById('upload-progress');

        // íŒŒì¼ ì„ íƒ íŠ¸ë¦¬ê±°
        function triggerFileUpload() {
            fileInput.click();
        }

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                selectedFiles = files;
                showUploadOptions();
            }
        });

        // ì—…ë¡œë“œ ì˜µì…˜ í‘œì‹œ
        function showUploadOptions() {
            uploadOptions.style.display = 'block';
            uploadOptions.scrollIntoView({ behavior: 'smooth' });
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleFileUpload() {
            if (selectedFiles.length === 0) return;

            const minRole = document.getElementById('min-role').value;
            const validFrom = document.getElementById('valid-from').value;
            const validTo = document.getElementById('valid-to').value;
            const description = document.getElementById('description').value;

            // ì§„í–‰ë¥  í‘œì‹œ
            uploadProgress.style.display = 'block';
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');

            try {
                let completedFiles = 0;

                for (const file of selectedFiles) {
                    // íŒŒì¼ í¬ê¸° ì²´í¬ (50MB)
                    if (file.size > 50 * 1024 * 1024) {
                        showAlert(`"${file.name}" íŒŒì¼ì´ 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`, 'error');
                        continue;
                    }

                    progressText.textContent = `"${file.name}" ì—…ë¡œë“œ ì¤‘...`;

                    try {
                        // ì‹¤ì œ íŒŒì¼ ì—…ë¡œë“œ
                        const formData = new FormData();
                        formData.append('file', file);
                        if (minRole) formData.append('min_role_name', minRole);
                        if (validFrom) formData.append('valid_from', validFrom);
                        if (validTo) formData.append('valid_to', validTo);
                        if (description) formData.append('description', description);

                        // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì™€ ì±„ë„ ì •ë³´ ì¶”ê°€
                        if (workspaceId) formData.append('workspace_id', workspaceId);
                        if (channelId) formData.append('channel_id', channelId);

                        let endpoint;
                        if (channelId) {
                            endpoint = `/channels/${channelId}/files`;
                        } else {
                            endpoint = `/workspaces/${workspaceId}/channels/${channelName}/files`;
                        }

                        await apiCall(endpoint, {
                            method: 'POST',
                            body: formData
                        });

                        completedFiles++;
                        const progress = (completedFiles / selectedFiles.length) * 100;
                        progressFill.style.width = progress + '%';

                    } catch (error) {
                        console.error(`íŒŒì¼ "${file.name}" ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
                        showAlert(`"${file.name}" ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                    }
                }

                // ì—…ë¡œë“œ ì™„ë£Œ
                progressText.textContent = `âœ… ${completedFiles}ê°œ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`;
                
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    uploadOptions.style.display = 'none';
                    resetUploadForm();
                    loadFiles(); // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }, 2000);

                if (completedFiles > 0) {
                    showAlert(`${completedFiles}ê°œ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }

            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                progressText.textContent = 'âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                showAlert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
                
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                }, 2000);
            }

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            fileInput.value = '';
            selectedFiles = [];
        }

        // ì—…ë¡œë“œ í¼ ì´ˆê¸°í™”
        function resetUploadForm() {
            document.getElementById('min-role').value = '';
            document.getElementById('valid-from').value = '';
            document.getElementById('valid-to').value = '';
            document.getElementById('description').value = '';
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        let dragCounter = 0;

        document.addEventListener('dragenter', function(e) {
            e.preventDefault();
            dragCounter++;
            uploadArea.classList.add('dragover');
        });

        document.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                uploadArea.classList.remove('dragover');
            }
        });

        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
            dragCounter = 0;
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                selectedFiles = files;
                showUploadOptions();
            }
        });

        // ============================
        // íŒŒì¼ ì•¡ì…˜
        // ============================

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadFile(fileId, filename) {
            try {
                if (IS_DEV_MODE) {
                    // ê°œë°œ ëª¨ë“œì—ì„œëŠ” ë‹¤ìš´ë¡œë“œ ì‹œë®¬ë ˆì´ì…˜
                    showAlert(`"${filename}" ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
                    return;
                }

                // ë‹¤ìš´ë¡œë“œ API í˜¸ì¶œ
                const response = await fetch(`${API_BASE_URL}/files/${fileId}/download`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
                }

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showAlert(`"${filename}" ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showAlert('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // íŒŒì¼ ê³µìœ 
        function shareFile(filename) {
            const shareText = `ğŸ“ íŒŒì¼ ê³µìœ : ${filename}\nì±„ë„: #${channelName}\nì›Œí¬ìŠ¤í˜ì´ìŠ¤: ${workspaceName}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showAlert(`"${filename}" íŒŒì¼ ì •ë³´ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }).catch(() => {
                    fallbackCopyText(shareText, filename);
                });
            } else {
                fallbackCopyText(shareText, filename);
            }
        }

        // í´ë¦½ë³´ë“œ ëŒ€ì²´ ë°©ë²•
        function fallbackCopyText(text, filename) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showAlert(`"${filename}" íŒŒì¼ ì •ë³´ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // íŒŒì¼ ì‚­ì œ
        async function deleteFile(fileId) {
            const file = currentFiles.find(f => (f.file_id || f.id) === fileId);
            if (!file) return;

            if (!confirm(`"${file.filename}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                await apiCall(`/files/${fileId}`, {
                    method: 'DELETE'
                });

                showAlert(`"${file.filename}" íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                loadFiles(); // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨

            } catch (error) {
                console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
                showAlert('íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

        // ============================
        // ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        // ============================

        document.addEventListener('DOMContentLoaded', function() {
            console.log(`ğŸ“ Files í˜ì´ì§€ ë¡œë“œë¨`);
            console.log(`- ì±„ë„: ${channelName} (ID: ${channelId})`);
            console.log(`- ì›Œí¬ìŠ¤í˜ì´ìŠ¤: ${workspaceName} (ID: ${workspaceId})`);
            console.log(`ğŸ”§ ê°œë°œ ëª¨ë“œ: ${IS_DEV_MODE}`);

            // ê°œë°œ ëª¨ë“œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¸ì¦ í™•ì¸
            if (!IS_DEV_MODE) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login.html';
                    return;
                }
            }

            // íŒŒì¼ ëª©ë¡ ë¡œë“œ
            loadFiles();

            // ì—…ë¡œë“œ ì˜µì…˜ì— ì—…ë¡œë“œ ë²„íŠ¼ ì¶”ê°€
            const uploadOptionsDiv = document.getElementById('upload-options');
            const uploadButton = document.createElement('button');
            uploadButton.className = 'upload-button';
            uploadButton.style.width = '100%';
            uploadButton.style.marginTop = '16px';
            uploadButton.textContent = 'ğŸ“¤ ì„ íƒëœ íŒŒì¼ ì—…ë¡œë“œ';
            uploadButton.onclick = handleFileUpload;
            uploadOptionsDiv.appendChild(uploadButton);

            // ë‚ ì§œ ì…ë ¥ ê¸°ë³¸ê°’ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('valid-from').min = today;
            document.getElementById('valid-to').min = today;

            // ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ë¡œ ì œí•œ
            document.getElementById('valid-from').addEventListener('change', function() {
                document.getElementById('valid-to').min = this.value;
            });

            // ê°œë°œ ëª¨ë“œ í‘œì‹œ
            if (IS_DEV_MODE) {
                document.body.style.borderTop = '4px solid #f59e0b';
                const devBadge = document.createElement('div');
                devBadge.innerHTML = 'ğŸ”§ ê°œë°œ ëª¨ë“œ';
                devBadge.style.cssText = `
                    position: fixed;
                    top: 4px;
                    right: 20px;
                    background: #f59e0b;
                    color: white;
                    padding: 4px 12px;
                    border-radius: 0 0 8px 8px;
                    font-size: 12px;
                    font-weight: 600;
                    z-index: 1000;
                `;
                document.body.appendChild(devBadge);
            }

            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + U: íŒŒì¼ ì—…ë¡œë“œ
                if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                    e.preventDefault();
                    triggerFileUpload();
                }
                
                // Escape: ì—…ë¡œë“œ ì˜µì…˜ ë‹«ê¸°
                if (e.key === 'Escape' && uploadOptions.style.display === 'block') {
                    uploadOptions.style.display = 'none';
                    resetUploadForm();
                }

                // Enter: ì—…ë¡œë“œ ì‹¤í–‰
                if (e.key === 'Enter' && uploadOptions.style.display === 'block') {
                    handleFileUpload();
                }
            });

            console.log('ğŸ“ Files í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            // ì—…ë¡œë“œ ì¤‘ì¸ ì‘ì—… ì •ë¦¬
            if (uploadProgress.style.display === 'block') {
                // ì—…ë¡œë“œ ì¤‘ì¸ ê²½ìš° ê²½ê³  ë©”ì‹œì§€
                return 'íŒŒì¼ ì—…ë¡œë“œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            }
        });

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ë””ë²„ê¹…ìš©)
        window.filesDebug = {
            currentFiles: () => currentFiles,
            loadFiles: loadFiles,
            channelName: channelName,
            workspaceName: workspaceName,
            channelId: channelId,
            workspaceId: workspaceId,
            IS_DEV_MODE: IS_DEV_MODE,
            apiCall: apiCall,
            mockFiles: MOCK_FILES
        };
    </script>
</body>
</html>