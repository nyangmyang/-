<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>워크스페이스 - WorkSpace</title>
    
    
    <!-- CSS 파일들 임포트 -->
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/workspace-main.css">
</head>
<body>
    <!-- 파일 입력 (숨김) -->
    <input type="file" id="file-input" multiple accept="*/*">

    <!-- 사이드바 -->
    <div class="sidebar">
        <div class="workspace-header">
            <div class="workspace-name" id="workspace-name">🌊 로딩중...</div>
            <div class="workspace-info" id="workspace-info">팀 협업 공간</div>
        </div>
        
        <div class="channels-section">
            <div class="section-header">
                <div class="section-title">채널</div>
                <button class="refresh-btn" onclick="location.reload()" title="새로고침">🔄</button>
            </div>
            
            <ul class="channel-list" id="channel-list">
                <!-- 채널들이 여기에 동적으로 추가됩니다 -->
            </ul>
            
            <div class="add-channel-button">
                <button class="add-channel-btn" onclick="location.href='channel-add.html'">
                    ➕ 채널 추가
                </button>
            </div>
        </div>

        <div class="user-section">
            <div class="section-title">팀원</div>
            <div id="team-members-list">
                <!-- 팀원 목록이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
        <header class="chat-header">
            <div class="header-left">
                <h1 id="current-channel-title"># 로딩중...</h1>
                <p id="current-channel-description">채널 정보를 가져오는 중...</p>
            </div>
            <div class="header-right">
                <span class="channel-badge public" id="channel-type-badge">🌍 공개</span>
                <button class="settings-btn" onclick="showChannelSettings()">⚙️</button>
            </div>
        </header>

        <!-- 탭 네비게이션 -->
        <nav class="content-tabs">
            <button class="tab-button active" data-tab="chat" onclick="switchTab('chat')">
                💬 대화
                <span class="tab-count" id="message-count">0</span>
            </button>
            <button class="tab-button" data-tab="files" onclick="switchTab('files')">
                📁 파일
                <span class="tab-count" id="file-count">0</span>
            </button>
        </nav>

        <!-- 채팅 탭 (기본) -->
        <div class="tab-content active" id="chat-content">
            <div class="chat-content">
                <div class="welcome-section" id="welcome-message">
                    <div class="welcome-icon">🏠</div>
                    <div class="welcome-title">채널에 오신 것을 환영합니다</div>
                    <div class="welcome-description">
                        자유롭게 소통하고 파일을 공유하세요. ⭐
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <!-- 메시지들이 여기에 동적으로 표시됩니다 -->
                </div>

                <div class="message-input-container">
                    <textarea class="message-input" id="message-input" placeholder="메시지를 입력하세요..." rows="1"></textarea>
                    <div class="input-toolbar">
                        <div class="input-actions">
                            <button class="input-btn" onclick="attachFile()" title="파일 첨부">📎</button>
                            <button class="input-btn" onclick="addEmoji()" title="이모지">😊</button>
                            <button class="input-btn" onclick="mentionUser()" title="멘션">@</button>
                            <button class="input-btn" onclick="voiceMessage()" title="음성 메시지">🎤</button>
                        </div>
                        <button class="send-btn" id="send-btn" onclick="sendMessage()">전송</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 파일 탭 -->
        <div class="tab-content" id="files-content">
            <div class="files-content">
                <div class="upload-area" id="upload-area" onclick="triggerFileUpload()">
                    <div class="upload-icon">📁</div>
                    <div class="upload-title">파일 업로드</div>
                    <div class="upload-description">
                        파일을 드래그하여 놓거나 클릭하여 선택하세요
                    </div>
                    <button class="upload-button">📤 파일 선택</button>
                </div>

                <div id="files-list-container">
                    <!-- 파일 목록이 여기에 동적으로 추가됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loading-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">⏳</div>
            <h3 class="modal-title">워크스페이스 로딩 중...</h3>
            <p class="modal-description">데이터를 불러오고 있습니다.</p>
        </div>
    </div>

    <!-- 새 채널 환영 모달 -->
    <div id="new-channel-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">🎉</div>
            <h3 class="modal-title">새 채널이 생성되었습니다!</h3>
            <p class="modal-description" id="new-channel-message">채널이 성공적으로 추가되었습니다.</p>
            <button class="modal-button" onclick="closeNewChannelModal()">확인</button>
        </div>
    </div>

    <script>
        // 강제 개발 모드 설정
        const IS_DEV_MODE = true;

        // Mock 데이터 (개발 모드용)
        const MOCK_DATA = {
            channels: [
                {
                    name: '전체',
                    is_public: true,
                    created_by: 'admin@example.com',
                    is_default: true,
                    created_at: '2025-01-01T00:00:00'
                }
            ],
            messages: {
                '전체': [
                    {
                        user_email: 'admin@example.com',
                        content: '워크스페이스에 오신 것을 환영합니다! 🎉',
                        created_at: '2025-01-15T09:00:00'
                    }
                ]
            },
            files: {
                '전체': []
            },
            teamMembers: [
                { user_email: 'admin@example.com', role_name: '관리자', is_online: true },
                { user_email: 'dev@example.com', role_name: '개발자', is_online: true },
                { user_email: 'design@example.com', role_name: '디자이너', is_online: false }
            ]
        };

        // 전역 데이터 저장소
        let globalData = {
            user: null,
            workspace: null,
            channels: [],
            currentChannel: null,
            messages: {},  
            files: {},     
            teamMembers: []
        };
        
        let currentChannelName = null;
        let currentTab = 'chat';

        // 개발 모드용 API 호출 함수
        async function devApiCall(url, options = {}) {
            console.log(`🔧 DEV MODE: API 호출 시뮬레이션 - ${options.method || 'GET'} ${url}`);
            await new Promise(resolve => setTimeout(resolve, 100));
            
            if (url.includes('/channels') && options.method === 'POST') {
                return {
                    user_email: globalData.user.user_email,
                    content: JSON.parse(options.body).content,
                    created_at: new Date().toISOString()
                };
            }
            
            if (url.includes('/messages')) {
                const channelName = url.split('/channels/')[1].split('/messages')[0];
                return MOCK_DATA.messages[channelName] || [];
            }
            
            if (url.includes('/files')) {
                const channelName = url.split('/channels/')[1].split('/files')[0];
                return MOCK_DATA.files[channelName] || [];
            }
            
            if (url.includes('/channels')) {
                return MOCK_DATA.channels;
            }
            
            return {};
        }

        // JWT 토큰에서 사용자 정보 추출
        function getUserInfoFromToken() {
            return {
                user_id: 1,
                user_email: 'test@example.com',
                workspace_id: 1,
                workspace_name: '테스트 워크스페이스',
                role_id: 2,
                role_name: '개발자',
                is_workspace_admin: true,
                is_contractor: false
            };
        }

        // 초기 데이터 로딩
        async function initializeWorkspace() {
            try {
                const userInfo = getUserInfoFromToken();
                globalData.user = userInfo;
                globalData.workspace = {
                    name: userInfo.workspace_name,
                    id: userInfo.workspace_id
                };

                document.getElementById('workspace-name').textContent = `🌊 ${userInfo.workspace_name}`;
                document.getElementById('workspace-info').textContent = `${userInfo.role_name} • ${userInfo.is_workspace_admin ? '관리자' : '멤버'}`;

                globalData.channels = MOCK_DATA.channels;
                globalData.teamMembers = MOCK_DATA.teamMembers;
                
                const defaultChannel = globalData.channels.find(ch => ch.name === '전체') || globalData.channels[0];
                if (defaultChannel) {
                    currentChannelName = defaultChannel.name;
                    globalData.currentChannel = defaultChannel;
                    globalData.messages[defaultChannel.name] = MOCK_DATA.messages[defaultChannel.name] || [];
                    globalData.files[defaultChannel.name] = MOCK_DATA.files[defaultChannel.name] || [];
                    renderChannelList();
                    renderTeamMembers();
                    updateChannelContent();
                }

            } catch (error) {
                console.error('워크스페이스 초기화 실패:', error);
            }
        }

        // 채널 목록 렌더링
        function renderChannelList() {
            const channelList = document.getElementById('channel-list');
            
            channelList.innerHTML = globalData.channels.map(channel => {
                const isActive = channel.name === currentChannelName ? 'active' : '';
                const visibilityIcon = channel.is_public ? '#' : '🔒';
                const messageCount = globalData.messages[channel.name]?.length || 0;
                
                return `
                    <li class="channel-item ${isActive}" data-channel-name="${channel.name}" onclick="switchChannel('${channel.name}')">
                        <span class="channel-icon">${visibilityIcon}</span>
                        <span class="channel-name">${channel.name}</span>
                        ${messageCount > 0 ? `<span class="message-count">${messageCount}</span>` : ''}
                    </li>
                `;
            }).join('');
        }

        // 팀원 목록 렌더링
        function renderTeamMembers() {
            const container = document.getElementById('team-members-list');
            const members = globalData.teamMembers || [];
            
            container.innerHTML = members.map(member => `
                <div style="display: flex; align-items: center; padding: 4px 0; color: rgba(255,255,255,0.8);">
                    <div style="width: 8px; height: 8px; border-radius: 50%; background: ${member.is_online ? '#10b981' : '#64748b'}; margin-right: 8px;"></div>
                    <span style="font-size: 14px;">${member.user_email.split('@')[0]}</span>
                </div>
            `).join('');
        }

        // 채널 전환
        async function switchChannel(channelName) {
            try {
                currentChannelName = channelName;
                
                const channel = globalData.channels.find(ch => ch.name === channelName);
                if (!channel) return;

                globalData.currentChannel = channel;
                
                renderChannelList();
                document.getElementById('current-channel-title').textContent = `# ${channel.name}`;
                document.getElementById('current-channel-description').textContent = 
                    channel.is_default ? '기본 채널입니다' : (channel.is_public ? '공개 채널입니다' : '비공개 채널입니다');
                
                const typeBadge = document.getElementById('channel-type-badge');
                if (channel.is_public) {
                    typeBadge.textContent = '🌍 공개';
                    typeBadge.className = 'channel-badge public';
                } else {
                    typeBadge.textContent = '🔒 비공개';
                    typeBadge.className = 'channel-badge private';
                }
                
                document.getElementById('message-input').placeholder = `# ${channel.name} 채널에 메시지 보내기`;
                updateChannelContent();

            } catch (error) {
                console.error('채널 전환 실패:', error);
            }
        }

        function updateChannelContent() {
            const channel = globalData.currentChannel;
            if (!channel) return;
            
            const welcomeMessage = document.getElementById('welcome-message');
            welcomeMessage.innerHTML = `
                <div class="welcome-icon">🏠</div>
                <div class="welcome-title"># ${channel.name} 채널에 오신 것을 환영합니다</div>
                <div class="welcome-description">
                    ${channel.is_public ? '모든 멤버가 참여할 수 있는 공개 채널입니다.' : '초대받은 멤버만 참여할 수 있는 비공개 채널입니다.'} 자유롭게 소통하고 파일을 공유하세요. ⭐
                </div>
            `;

            const messages = globalData.messages[channel.name] || [];
            const files = globalData.files[channel.name] || [];
            
            document.getElementById('message-count').textContent = messages.length;
            document.getElementById('file-count').textContent = files.length;

            renderMessages();
            renderFiles();
        }

        // 탭 전환
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // 메시지 렌더링
        function renderMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            const messages = globalData.messages[currentChannelName] || [];
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px 24px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1e293b;">아직 메시지가 없습니다</div>
                        <div style="font-size: 15px;">첫 번째 메시지를 보내보세요!</div>
                    </div>
                `;
                return;
            }
            
            messagesContainer.innerHTML = messages.map(message => {
                const messageTime = new Date(message.created_at).toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <div class="message">
                        <div class="message-avatar">${message.user_email.charAt(0).toUpperCase()}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${message.user_email}</span>
                                <span class="message-time">${messageTime}</span>
                            </div>
                            <div class="message-text">${message.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // 메시지 전송
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content || !currentChannelName) return;

            try {
                const result = await devApiCall(`/channels/${currentChannelName}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });
                
                if (result) {
                    if (!globalData.messages[currentChannelName]) {
                        globalData.messages[currentChannelName] = [];
                    }
                    globalData.messages[currentChannelName].push(result);
                }
                
                renderMessages();
                updateChannelContent();
                
                input.value = '';
                input.style.height = 'auto';
                updateSendButton();
                
            } catch (error) {
                console.error('메시지 전송 오류:', error);
                alert('메시지 전송에 실패했습니다.');
            }
        }

        // 파일 렌더링
        function renderFiles() {
            const filesContainer = document.getElementById('files-list-container');
            const files = globalData.files[currentChannelName] || [];
            
            if (files.length === 0) {
                filesContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px 24px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📁</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #1e293b;">아직 업로드된 파일이 없습니다</div>
                        <div style="font-size: 15px;">파일을 업로드하여 팀원들과 공유해보세요!</div>
                    </div>
                `;
                return;
            }

            filesContainer.innerHTML = files.map(file => {
                const uploadTime = new Date(file.uploaded_at).toLocaleString('ko-KR');
                
                return `
                    <div style="display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px; background: white;">
                        <div style="font-size: 20px; margin-right: 12px;">📄</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 2px;">${file.filename}</div>
                            <div style="font-size: 13px; color: #64748b;">업로드: ${file.uploaded_by} • ${uploadTime}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 메시지 입력 관련
        function updateSendButton() {
            const sendBtn = document.getElementById('send-btn');
            const hasText = document.getElementById('message-input').value.trim().length > 0;
            sendBtn.disabled = !hasText;
        }

        // 파일 업로드 관련
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }

        function attachFile() {
            triggerFileUpload();
        }

        // 기타 기능들
        function addEmoji() {
            const input = document.getElementById('message-input');
            const emojis = ['😊', '👍', '❤️', '🎉', '💯', '🔥', '✨', '🚀'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + randomEmoji + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + 2, cursorPos + 2);
            updateSendButton();
        }

        function mentionUser() {
            alert('멘션 기능은 개발 중입니다.');
        }

        function voiceMessage() {
            alert('음성 메시지 기능은 개발 중입니다.');
        }

        function showChannelSettings() {
            const channel = globalData.currentChannel;
            if (!channel) return;
            
            alert(`⚙️ 채널 설정\n\n채널명: ${channel.name}\n타입: ${channel.is_public ? '공개' : '비공개'}\n생성자: ${channel.created_by}\n생성일: ${new Date(channel.created_at).toLocaleDateString('ko-KR')}`);
        }

        function closeNewChannelModal() {
            document.getElementById('new-channel-modal').style.display = 'none';
        }

        // 페이지 초기화
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loading-overlay').style.display = 'none';
            initializeWorkspace();
            updateSendButton();
            
            // 메시지 입력 이벤트 리스너
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                updateSendButton();
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            console.log('🔧 개발 모드로 실행 중입니다.');
        });
    </script>
</body>
</html>
