<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›Œí¬ìŠ¤í˜ì´ìŠ¤ - WorkSpace</title>
    
    <!-- CSS íŒŒì¼ë“¤ ì„í¬íŠ¸ -->
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/workspace-main.css">
</head>
<body>
    <!-- íŒŒì¼ ì…ë ¥ (ìˆ¨ê¹€) -->
    <input type="file" id="file-input" multiple accept="*/*">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="workspace-header">
            <div class="workspace-name" id="workspace-name">ğŸŒŠ ë¡œë”©ì¤‘...</div>
            <div class="workspace-info" id="workspace-info">íŒ€ í˜‘ì—… ê³µê°„</div>
        </div>
        
        <div class="channels-section">
            <div class="section-header">
                <div class="section-title">ì±„ë„</div>
                <button class="refresh-btn" onclick="refreshChannels()" title="ì±„ë„ ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
            </div>
            
            <!-- ì±„ë„ ëª©ë¡ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
            <div class="channel-list-container">
                <ul class="channel-list" id="channel-list">
                    <!-- ì±„ë„ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
            </div>
            
            <div class="add-channel-button">
                <button class="add-channel-btn" onclick="location.href='channel-add.html'">
                    â• ì±„ë„ ì¶”ê°€
                </button>
            </div>
        </div>

        <div class="user-section">
            <div class="section-title">íŒ€ì›</div>
            <!-- íŒ€ì› ëª©ë¡ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
            <div class="team-members-container">
                <div id="team-members-list">
                    <!-- íŒ€ì› ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <header class="chat-header">
            <div class="header-left">
                <h1 id="current-channel-title"># ë¡œë”©ì¤‘...</h1>
                <p id="current-channel-description">ì±„ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div class="header-right">
                <span class="channel-badge public" id="channel-type-badge">ğŸŒ ê³µê°œ</span>
                <button class="settings-btn" id="workspace-settings-btn" onclick="goToWorkspaceSettings()" title="ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„¤ì •" style="display: none;">âš™ï¸</button>
            </div>
        </header>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="content-tabs">
            <button class="tab-button active" data-tab="chat" onclick="switchTab('chat')">
                ğŸ’¬ ëŒ€í™”
                <span class="tab-count" id="message-count">0</span>
            </button>
            <button class="tab-button" data-tab="files" onclick="switchTab('files')">
                ğŸ“ íŒŒì¼
                <span class="tab-count" id="file-count">0</span>
            </button>
        </nav>

        <!-- ì±„íŒ… íƒ­ (ê¸°ë³¸) -->
        <div class="tab-content active" id="chat-content">
            <div class="chat-content">
                <div class="welcome-section" id="welcome-message">
                    <div class="welcome-icon">ğŸ </div>
                    <div class="welcome-title">ì±„ë„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</div>
                    <div class="welcome-description">
                        ììœ ë¡­ê²Œ ì†Œí†µí•˜ê³  íŒŒì¼ì„ ê³µìœ í•˜ì„¸ìš”. â­
                    </div>
                </div>

                <!-- ì±„íŒ… ë©”ì‹œì§€ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
                <div class="chat-messages-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="message-input-container">
                    <textarea class="message-input" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
                    <div class="input-toolbar">
                        <div class="input-actions">
                            <button class="input-btn" onclick="attachFile()" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</button>
                            <button class="input-btn" onclick="addEmoji()" title="ì´ëª¨ì§€">ğŸ˜Š</button>
                            <button class="input-btn" onclick="mentionUser()" title="ë©˜ì…˜">@</button>
                            <button class="input-btn" onclick="voiceMessage()" title="ìŒì„± ë©”ì‹œì§€">ğŸ¤</button>
                        </div>
                        <button class="send-btn" id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- íŒŒì¼ íƒ­ -->
        <div class="tab-content" id="files-content">
            <div class="files-content">
                <div class="upload-area" id="upload-area" onclick="triggerFileUpload()">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-title">íŒŒì¼ ì—…ë¡œë“œ</div>
                    <div class="upload-description">
                        íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
                    </div>
                    <button class="upload-button">ğŸ“¤ íŒŒì¼ ì„ íƒ</button>
                </div>

                <!-- íŒŒì¼ ëª©ë¡ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
                <div class="files-list-container">
                    <div id="files-list">
                        <!-- íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">â³</div>
            <h3 class="modal-title">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¡œë”© ì¤‘...</h3>
            <p class="modal-description">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ìƒˆ ì±„ë„ í™˜ì˜ ëª¨ë‹¬ -->
    <div id="new-channel-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">ğŸ‰</div>
            <h3 class="modal-title">ìƒˆ ì±„ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
            <p class="modal-description" id="new-channel-message">ì±„ë„ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button class="modal-button" onclick="closeNewChannelModal()">í™•ì¸</button>
        </div>
    </div>


    <script>
        // ì„œë²„ ì—°ê²° ëª¨ë“œ ì„¤ì • (ì‹¤ì œ ì„œë²„ ì—°ê²° ì‹œ falseë¡œ ë³€ê²½)
        const IS_DEV_MODE = true;
        const API_BASE_URL = '/api/v1'; // ì‹¤ì œ API ê¸°ë³¸ URL
        const WEBSOCKET_URL = 'ws://localhost:8080/ws'; // WebSocket URL

        // Mock ë°ì´í„° (ê°œë°œ ëª¨ë“œìš©)
        const MOCK_DATA = {
            channels: [
                {
                    name: 'ì „ì²´',
                    is_public: true,
                    created_by: 'admin@example.com',
                    is_default: true,
                    created_at: '2025-01-01T00:00:00'
                },
                {
                    name: 'ê°œë°œíŒ€',
                    is_public: false,
                    created_by: 'dev@example.com',
                    is_default: false,
                    created_at: '2025-01-02T00:00:00'
                },
                {
                    name: 'ë””ìì¸íŒ€',
                    is_public: true,
                    created_by: 'design@example.com',
                    is_default: false,
                    created_at: '2025-01-03T00:00:00'
                }
            ],
            messages: {
                'ì „ì²´': [
                    {
                        user_email: 'admin@example.com',
                        content: 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰',
                        created_at: '2025-01-15T09:00:00'
                    },
                    {
                        user_email: 'dev@example.com',
                        content: 'ì•ˆë…•í•˜ì„¸ìš”! ê°œë°œíŒ€ì…ë‹ˆë‹¤.',
                        created_at: '2025-01-15T09:05:00'
                    }
                ],
                'ê°œë°œíŒ€': [
                    {
                        user_email: 'dev@example.com',
                        content: 'ì˜¤ëŠ˜ ìŠ¤í”„ë¦°íŠ¸ ë¦¬ë·° ìˆì–´ìš”!',
                        created_at: '2025-01-15T10:00:00'
                    }
                ],
                'ë””ìì¸íŒ€': []
            },
            files: {
                'ì „ì²´': [
                    {
                        filename: 'í”„ë¡œì íŠ¸_ê³„íšì„œ.pdf',
                        uploaded_by: 'admin@example.com',
                        uploaded_at: '2025-01-15T08:00:00',
                        file_size: '2.3MB'
                    }
                ],
                'ê°œë°œíŒ€': [],
                'ë””ìì¸íŒ€': []
            },
            teamMembers: [
                { user_email: 'admin@example.com', role_name: 'ê´€ë¦¬ì', is_online: true },
                { user_email: 'dev@example.com', role_name: 'ê°œë°œì', is_online: true },
                { user_email: 'design@example.com', role_name: 'ë””ìì´ë„ˆ', is_online: false },
                { user_email: 'pm@example.com', role_name: 'PM', is_online: true }
            ]
        };

        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        let globalData = {
            user: null,
            workspace: null,
            channels: [],
            currentChannel: null,
            messages: {},  
            files: {},     
            teamMembers: []
        };
        
        let currentChannelName = null;
        let currentTab = 'chat';
        let websocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;

        // API í˜¸ì¶œ í•¨ìˆ˜ (ì‹¤ì œ ì„œë²„ ì—°ê²° ì‹œ ì‚¬ìš©)
        async function apiCall(endpoint, options = {}) {
            if (IS_DEV_MODE) {
                return await devApiCall(endpoint, options);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`,
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                updateConnectionStatus('offline');
                throw error;
            }
        }

        // ê°œë°œ ëª¨ë“œìš© API í˜¸ì¶œ í•¨ìˆ˜
        async function devApiCall(url, options = {}) {
            console.log(`ğŸ”§ DEV MODE: API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜ - ${options.method || 'GET'} ${url}`);
            await new Promise(resolve => setTimeout(resolve, 200));
            
            if (url.includes('/channels') && options.method === 'POST') {
                return {
                    user_email: globalData.user.user_email,
                    content: JSON.parse(options.body).content,
                    created_at: new Date().toISOString()
                };
            }
            
            if (url.includes('/messages')) {
                const channelName = url.split('/channels/')[1].split('/messages')[0];
                return MOCK_DATA.messages[channelName] || [];
            }
            
            if (url.includes('/files')) {
                const channelName = url.split('/channels/')[1].split('/files')[0];
                return MOCK_DATA.files[channelName] || [];
            }
            
            if (url.includes('/channels')) {
                return MOCK_DATA.channels;
            }

            if (url.includes('/team-members')) {
                return MOCK_DATA.teamMembers;
            }
            
            return {};
        }

        // WebSocket ì—°ê²° ê´€ë¦¬
        function connectWebSocket() {
            if (IS_DEV_MODE) {
                updateConnectionStatus('online');
                return;
            }

            try {
                websocket = new WebSocket(WEBSOCKET_URL);
                
                websocket.onopen = function() {
                    console.log('WebSocket ì—°ê²°ë¨');
                    updateConnectionStatus('online');
                    reconnectAttempts = 0;
                };

                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };

                websocket.onclose = function() {
                    console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                    updateConnectionStatus('offline');
                    attemptReconnect();
                };

                websocket.onerror = function(error) {
                    console.error('WebSocket ì˜¤ë¥˜:', error);
                    updateConnectionStatus('offline');
                };
            } catch (error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                updateConnectionStatus('offline');
            }
        }

        function attemptReconnect() {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                updateConnectionStatus('reconnecting');
                setTimeout(() => {
                    console.log(`ì¬ì—°ê²° ì‹œë„ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);
                    connectWebSocket();
                }, 3000 * reconnectAttempts);
            }
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'new_message':
                    if (data.channel === currentChannelName) {
                        if (!globalData.messages[data.channel]) {
                            globalData.messages[data.channel] = [];
                        }
                        globalData.messages[data.channel].push(data.message);
                        renderMessages();
                        updateChannelContent();
                    }
                    break;
                case 'channel_update':
                    refreshChannels();
                    break;
                case 'member_status_update':
                    refreshTeamMembers();
                    break;
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connection-status');
            const statusText = document.querySelector('.status-text');
            
            statusElement.className = `connection-status ${status}`;
            
            switch (status) {
                case 'online':
                    statusText.textContent = 'ì˜¨ë¼ì¸';
                    break;
                case 'offline':
                    statusText.textContent = 'ì˜¤í”„ë¼ì¸';
                    break;
                case 'reconnecting':
                    statusText.textContent = 'ì¬ì—°ê²° ì¤‘...';
                    break;
            }
        }

        // JWT í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
        function getUserInfoFromToken() {
            if (IS_DEV_MODE) {
                return {
                    user_id: 1,
                    user_email: 'test@example.com',
                    workspace_id: 1,
                    workspace_name: 'í…ŒìŠ¤íŠ¸ ì›Œí¬ìŠ¤í˜ì´ìŠ¤',
                    role_id: 2,
                    role_name: 'ê°œë°œì',
                    is_workspace_admin: true,
                    is_contractor: false
                };
            }

            const token = localStorage.getItem('jwt_token');
            if (!token) {
                window.location.href = '/login.html';
                return null;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload;
            } catch (error) {
                console.error('í† í° íŒŒì‹± ì‹¤íŒ¨:', error);
                localStorage.removeItem('jwt_token');
                window.location.href = '/login.html';
                return null;
            }
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë”©
        async function initializeWorkspace() {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                
                const userInfo = getUserInfoFromToken();
                if (!userInfo) return;
                
                globalData.user = userInfo;
                globalData.workspace = {
                    name: userInfo.workspace_name,
                    id: userInfo.workspace_id
                };

                document.getElementById('workspace-name').textContent = `ğŸŒŠ ${userInfo.workspace_name}`;
                document.getElementById('workspace-info').textContent = `${userInfo.role_name} â€¢ ${userInfo.is_workspace_admin ? 'ê´€ë¦¬ì' : 'ë©¤ë²„'}`;

                // ê´€ë¦¬ìì¸ ê²½ìš°ë§Œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„¤ì • ë²„íŠ¼ í‘œì‹œ
                if (userInfo.is_workspace_admin) {
                    document.getElementById('workspace-settings-btn').style.display = 'block';
                }

                // ë³‘ë ¬ë¡œ ë°ì´í„° ë¡œë”©
                await Promise.all([
                    loadChannels(),
                    loadTeamMembers()
                ]);
                
                const defaultChannel = globalData.channels.find(ch => ch.is_default) || globalData.channels[0];
                if (defaultChannel) {
                    await switchChannel(defaultChannel.name);
                }

                connectWebSocket();

            } catch (error) {
                console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // ì±„ë„ ëª©ë¡ ë¡œë”©
        async function loadChannels() {
            try {
                const channels = await apiCall('/channels');
                globalData.channels = channels;
                renderChannelList();
            } catch (error) {
                console.error('ì±„ë„ ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        // íŒ€ì› ëª©ë¡ ë¡œë”©
        async function loadTeamMembers() {
            try {
                const members = await apiCall('/team-members');
                globalData.teamMembers = members;
                renderTeamMembers();
            } catch (error) {
                console.error('íŒ€ì› ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        // ì±„ë„ ëª©ë¡ ë Œë”ë§
        function renderChannelList() {
            const channelList = document.getElementById('channel-list');
            
            channelList.innerHTML = globalData.channels.map(channel => {
                const isActive = channel.name === currentChannelName ? 'active' : '';
                const visibilityIcon = channel.is_public ? '#' : 'ğŸ”’';
                const messageCount = globalData.messages[channel.name]?.length || 0;
                
                return `
                    <li class="channel-item ${isActive}" data-channel-name="${channel.name}" onclick="switchChannel('${channel.name}')">
                        <span class="channel-icon">${visibilityIcon}</span>
                        <span class="channel-name">${channel.name}</span>
                        ${messageCount > 0 ? `<span class="message-count">${messageCount}</span>` : ''}
                    </li>
                `;
            }).join('');
        }

        // íŒ€ì› ëª©ë¡ ë Œë”ë§
        function renderTeamMembers() {
            const container = document.getElementById('team-members-list');
            const members = globalData.teamMembers || [];
            
            container.innerHTML = members.map(member => `
                <div class="team-member-item">
                    <div class="member-status ${member.is_online ? 'online' : 'offline'}"></div>
                    <span class="member-name">${member.user_email.split('@')[0]}</span>
                    <span class="member-role">${member.role_name}</span>
                </div>
            `).join('');
        }

        // ì±„ë„ ìƒˆë¡œê³ ì¹¨
        async function refreshChannels() {
            await loadChannels();
            if (currentChannelName) {
                await loadChannelData(currentChannelName);
                updateChannelContent();
            }
        }

        // íŒ€ì› ìƒˆë¡œê³ ì¹¨
        async function refreshTeamMembers() {
            await loadTeamMembers();
        }

        // ì±„ë„ ë°ì´í„° ë¡œë”©
        async function loadChannelData(channelName) {
            try {
                const [messages, files] = await Promise.all([
                    apiCall(`/channels/${channelName}/messages`),
                    apiCall(`/channels/${channelName}/files`)
                ]);
                
                globalData.messages[channelName] = messages;
                globalData.files[channelName] = files;
            } catch (error) {
                console.error('ì±„ë„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        // ì±„ë„ ì „í™˜
        async function switchChannel(channelName) {
            try {
                currentChannelName = channelName;
                
                const channel = globalData.channels.find(ch => ch.name === channelName);
                if (!channel) return;

                globalData.currentChannel = channel;
                
                // ì±„ë„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë”©
                if (!globalData.messages[channelName]) {
                    await loadChannelData(channelName);
                }
                
                renderChannelList();
                document.getElementById('current-channel-title').textContent = `# ${channel.name}`;
                document.getElementById('current-channel-description').textContent = 
                    channel.is_default ? 'ê¸°ë³¸ ì±„ë„ì…ë‹ˆë‹¤' : (channel.is_public ? 'ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤' : 'ë¹„ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤');
                
                const typeBadge = document.getElementById('channel-type-badge');
                if (channel.is_public) {
                    typeBadge.textContent = 'ğŸŒ ê³µê°œ';
                    typeBadge.className = 'channel-badge public';
                } else {
                    typeBadge.textContent = 'ğŸ”’ ë¹„ê³µê°œ';
                    typeBadge.className = 'channel-badge private';
                }
                
                document.getElementById('message-input').placeholder = `# ${channel.name} ì±„ë„ì— ë©”ì‹œì§€ ë³´ë‚´ê¸°`;
                updateChannelContent();

            } catch (error) {
                console.error('ì±„ë„ ì „í™˜ ì‹¤íŒ¨:', error);
            }
        }

        function updateChannelContent() {
            const channel = globalData.currentChannel;
            if (!channel) return;
            
            const welcomeMessage = document.getElementById('welcome-message');
            welcomeMessage.innerHTML = `
                <div class="welcome-icon">ğŸ </div>
                <div class="welcome-title"># ${channel.name} ì±„ë„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</div>
                <div class="welcome-description">
                    ${channel.is_public ? 'ëª¨ë“  ë©¤ë²„ê°€ ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤.' : 'ì´ˆëŒ€ë°›ì€ ë©¤ë²„ë§Œ ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ë¹„ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤.'} ììœ ë¡­ê²Œ ì†Œí†µí•˜ê³  íŒŒì¼ì„ ê³µìœ í•˜ì„¸ìš”. â­
                </div>
            `;

            const messages = globalData.messages[channel.name] || [];
            const files = globalData.files[channel.name] || [];
            
            document.getElementById('message-count').textContent = messages.length;
            document.getElementById('file-count').textContent = files.length;

            renderMessages();
            renderFiles();
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // ë©”ì‹œì§€ ë Œë”ë§
        function renderMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            const messages = globalData.messages[currentChannelName] || [];
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <div class="empty-title">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-description">ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</div>
                    </div>
                `;
                return;
            }
            
            messagesContainer.innerHTML = messages.map(message => {
                const messageTime = new Date(message.created_at).toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <div class="message">
                        <div class="message-avatar">${message.user_email.charAt(0).toUpperCase()}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${message.user_email}</span>
                                <span class="message-time">${messageTime}</span>
                            </div>
                            <div class="message-text">${message.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content || !currentChannelName) return;

            try {
                const result = await apiCall(`/channels/${currentChannelName}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });
                
                if (result) {
                    if (!globalData.messages[currentChannelName]) {
                        globalData.messages[currentChannelName] = [];
                    }
                    globalData.messages[currentChannelName].push(result);
                }
                
                renderMessages();
                updateChannelContent();
                
                input.value = '';
                input.style.height = 'auto';
                updateSendButton();
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íŒŒì¼ ë Œë”ë§
        function renderFiles() {
            const filesContainer = document.getElementById('files-list');
            const files = globalData.files[currentChannelName] || [];
            
            if (files.length === 0) {
                filesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-title">ì•„ì§ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-description">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ íŒ€ì›ë“¤ê³¼ ê³µìœ í•´ë³´ì„¸ìš”!</div>
                    </div>
                `;
                return;
            }

            filesContainer.innerHTML = files.map(file => {
                const uploadTime = new Date(file.uploaded_at).toLocaleString('ko-KR');
                
                return `
                    <div class="file-item">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-info">
                            <div class="file-name">${file.filename}</div>
                            <div class="file-meta">ì—…ë¡œë“œ: ${file.uploaded_by} â€¢ ${uploadTime} â€¢ ${file.file_size}</div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn" onclick="downloadFile('${file.filename}')" title="ë‹¤ìš´ë¡œë“œ">ğŸ“¥</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadFile(filename) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì„œë²„ì—ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ URLì„ ë°›ì•„ì™€ì•¼ í•¨
            alert(`íŒŒì¼ ë‹¤ìš´ë¡œë“œ: ${filename}`);
        }

        // ë©”ì‹œì§€ ì…ë ¥ ê´€ë ¨
        function updateSendButton() {
            const sendBtn = document.getElementById('send-btn');
            const hasText = document.getElementById('message-input').value.trim().length > 0;
            sendBtn.disabled = !hasText;
        }

        // íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }

        function attachFile() {
            triggerFileUpload();
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('file-input').addEventListener('change', async function(event) {
            const files = event.target.files;
            if (!files.length || !currentChannelName) return;

            for (const file of files) {
                try {
                    await uploadFile(file);
                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert(`íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${file.name}`);
                }
            }
            
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            event.target.value = '';
        });

        // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadFile(file) {
            if (IS_DEV_MODE) {
                // ê°œë°œ ëª¨ë“œì—ì„œëŠ” Mock ë°ì´í„°ì— ì¶”ê°€
                const newFile = {
                    filename: file.name,
                    uploaded_by: globalData.user.user_email,
                    uploaded_at: new Date().toISOString(),
                    file_size: formatFileSize(file.size)
                };
                
                if (!globalData.files[currentChannelName]) {
                    globalData.files[currentChannelName] = [];
                }
                globalData.files[currentChannelName].push(newFile);
                renderFiles();
                updateChannelContent();
                return;
            }

            // ì‹¤ì œ ì„œë²„ ì—…ë¡œë“œ
            const formData = new FormData();
            formData.append('file', file);
            formData.append('channel', currentChannelName);

            const response = await fetch(`${API_BASE_URL}/channels/${currentChannelName}/files`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
            }

            const result = await response.json();
            
            if (!globalData.files[currentChannelName]) {
                globalData.files[currentChannelName] = [];
            }
            globalData.files[currentChannelName].push(result);
            renderFiles();
            updateChannelContent();
        }

        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            const filesContent = document.querySelector('.files-content');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                filesContent.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }

            uploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                handleFiles(files);
            }

            function handleFiles(files) {
                const fileInput = document.getElementById('file-input');
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        }

        // ê¸°íƒ€ ê¸°ëŠ¥ë“¤
        function addEmoji() {
            const input = document.getElementById('message-input');
            const emojis = ['ğŸ˜Š', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'ğŸ’¯', 'ğŸ”¥', 'âœ¨', 'ğŸš€', 'ğŸ‘', 'ğŸ’ª'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + randomEmoji + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + 2, cursorPos + 2);
            updateSendButton();
        }

        function mentionUser() {
            const input = document.getElementById('message-input');
            const members = globalData.teamMembers || [];
            
            if (members.length === 0) {
                alert('ë©˜ì…˜í•  ìˆ˜ ìˆëŠ” íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê°„ë‹¨í•œ ë©˜ì…˜ êµ¬í˜„ (ì‹¤ì œë¡œëŠ” ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë“±ì´ í•„ìš”)
            const randomMember = members[Math.floor(Math.random() * members.length)];
            const mention = `@${randomMember.user_email.split('@')[0]} `;
            
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + mention + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + mention.length, cursorPos + mention.length);
            updateSendButton();
        }

        function voiceMessage() {
            alert('ìŒì„± ë©”ì‹œì§€ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
        }

        function closeNewChannelModal() {
            document.getElementById('new-channel-modal').style.display = 'none';
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+K: ë¹ ë¥¸ ì±„ë„ ê²€ìƒ‰ (ë¯¸êµ¬í˜„)
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    alert('ë¹ ë¥¸ ì±„ë„ ê²€ìƒ‰ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
                }
                
                // Ctrl+/: ë‹¨ì¶•í‚¤ ë„ì›€ë§
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }
            });
        }

        function showKeyboardShortcuts() {
            alert(`
âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤

ğŸ’¬ ë©”ì‹œì§€
â€¢ Enter: ë©”ì‹œì§€ ì „ì†¡
â€¢ Shift+Enter: ì¤„ë°”ê¿ˆ

ğŸ” íƒìƒ‰
â€¢ Ctrl+K: ë¹ ë¥¸ ì±„ë„ ê²€ìƒ‰
â€¢ â†‘/â†“: ì±„ë„ ëª©ë¡ íƒìƒ‰

âš™ï¸ ê¸°íƒ€
â€¢ Ctrl+/: ë‹¨ì¶•í‚¤ ë„ì›€ë§
â€¢ F5: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            `);
        }

        // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (ìƒˆ ì±„ë„ ì•Œë¦¼ ë“±)
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const newChannel = urlParams.get('new_channel');
            
            if (newChannel) {
                document.getElementById('new-channel-message').textContent = 
                    `'${newChannel}' ì±„ë„ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`;
                document.getElementById('new-channel-modal').style.display = 'flex';
                
                // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ìë™ ì €ì¥ ê¸°ëŠ¥ (ë©”ì‹œì§€ ì„ì‹œ ì €ì¥)
        function setupAutoSave() {
            const messageInput = document.getElementById('message-input');
            const STORAGE_KEY = 'draft_message_';
            
            // ë©”ì‹œì§€ ì„ì‹œ ì €ì¥
            messageInput.addEventListener('input', function() {
                if (currentChannelName) {
                    localStorage.setItem(STORAGE_KEY + currentChannelName, this.value);
                }
            });
            
            // ì±„ë„ ë³€ê²½ ì‹œ ì„ì‹œ ì €ì¥ëœ ë©”ì‹œì§€ ë³µì›
            function restoreDraftMessage() {
                if (currentChannelName) {
                    const draft = localStorage.getItem(STORAGE_KEY + currentChannelName);
                    if (draft) {
                        messageInput.value = draft;
                        updateSendButton();
                    }
                }
            }
            
            // ë©”ì‹œì§€ ì „ì†¡ í›„ ì„ì‹œ ì €ì¥ ì‚­ì œ
            const originalSendMessage = sendMessage;
            sendMessage = async function() {
                await originalSendMessage();
                if (currentChannelName) {
                    localStorage.removeItem(STORAGE_KEY + currentChannelName);
                }
            };
            
            return restoreDraftMessage;
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ ê°œë°œ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.');
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // ê¸°ëŠ¥ ì´ˆê¸°í™”
            const restoreDraftMessage = setupAutoSave();
            setupDragAndDrop();
            setupKeyboardShortcuts();
            handleUrlParameters();
            
            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸°í™”
            initializeWorkspace().then(() => {
                restoreDraftMessage();
            });
            
            updateSendButton();
            
            // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                updateSendButton();
            });

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸ (ê°œë°œ ëª¨ë“œê°€ ì•„ë‹ ë•Œ)
            if (!IS_DEV_MODE) {
                setInterval(() => {
                    if (websocket && websocket.readyState !== WebSocket.OPEN) {
                        updateConnectionStatus('offline');
                        attemptReconnect();
                    }
                }, 30000); // 30ì´ˆë§ˆë‹¤ í™•ì¸
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ WebSocket ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
        });
    </script>
</body>
</html>